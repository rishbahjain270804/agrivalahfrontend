<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Farming - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: none;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .registration-table {
            border-radius: 10px;
            overflow: hidden;
        }
        .btn-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fa fa-leaf me-2"></i>
                Natural Farming Admin Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">
                    <i class="fa fa-home me-1"></i>Back to Website
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="total-registrations">-</div>
                    <div>Total Registrations</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="pending-registrations">-</div>
                    <div>Pending</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="approved-registrations">-</div>
                    <div>Approved</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-number" id="recent-registrations">-</div>
                    <div>Last 7 Days</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fa fa-users me-2"></i>Recent Registrations</h4>
                <div>
                    <select class="form-select d-inline-block me-2" style="width: auto;" id="status-filter">
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="certified">Certified</option>
                    </select>
                    <button class="btn btn-refresh" onclick="loadDashboardData()">
                        <i class="fa fa-refresh me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Registration Table -->
            <div id="registrations-container">
                <div class="loading">
                    <i class="fa fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading registrations...</p>
                </div>
            </div>
        </div>

        <!-- API Status -->
        <div class="dashboard-card">
            <h5><i class="fa fa-server me-2"></i>System Status</h5>
            <div id="api-status" class="mt-3">
                <div class="loading">
                    <i class="fa fa-spinner fa-spin"></i>
                    Checking API status...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script>
        let currentStats = {};

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics
                const statsUrl = typeof getApiUrl === 'function' ? getApiUrl('/api/stats/dashboard') : '/api/stats/dashboard';
                const statsResponse = await fetch(statsUrl, { credentials: 'include' });
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    currentStats = statsData.stats;
                    updateStatistics(currentStats);
                } else {
                    showError('Failed to load statistics');
                }

                // Load registrations
                await loadRegistrations();

                // Check API status
                await checkAPIStatus();

            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('Failed to load dashboard data: ' + error.message);
            }
        }

        // Update statistics display
        function updateStatistics(stats) {
            document.getElementById('total-registrations').textContent = stats.total_registrations || 0;
            document.getElementById('pending-registrations').textContent = stats.pending_registrations || 0;
            document.getElementById('approved-registrations').textContent = stats.approved_registrations || 0;
            document.getElementById('recent-registrations').textContent = stats.recent_registrations || 0;
        }

        // Load registrations by status
        async function loadRegistrations() {
            const status = document.getElementById('status-filter').value;
            const container = document.getElementById('registrations-container');
            
            container.innerHTML = `
                <div class="loading">
                    <i class="fa fa-spinner fa-spin"></i>
                    Loading ${status} registrations...
                </div>
            `;

            try {
                const listUrl = typeof getApiUrl === 'function' ? getApiUrl('/api/list-registrations') : '/api/list-registrations';
                const response = await fetch(listUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status: status, limit: 20 })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayRegistrations(data.registrations);
                } else {
                    showError('Failed to load registrations');
                }
            } catch (error) {
                showError('Failed to load registrations: ' + error.message);
            }
        }

        // Display registrations table
        function displayRegistrations(registrations) {
            const container = document.getElementById('registrations-container');
            
            if (registrations.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
                        <p>No registrations found</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-hover registration-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Reference ID</th>
                                <th>Farmer Name</th>
                                <th>Contact</th>
                                <th>Location</th>
                                <th>Land (Ha)</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            registrations.forEach(reg => {
                const statusClass = getStatusClass(reg.status);
                tableHTML += `
                    <tr>
                        <td><code>${reg.reference_id}</code></td>
                        <td>${reg.farmer_name}</td>
                        <td>${reg.contact_number}</td>
                        <td>${reg.village_panchayat}, ${reg.district}</td>
                        <td>${reg.area_natural_farming}</td>
                        <td><span class="badge ${statusClass}">${reg.status}</span></td>
                        <td>${new Date(reg.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${reg.reference_id}')">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="updateStatus('${reg.reference_id}', 'approved')">
                                <i class="fa fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Get status badge class
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'approved': return 'bg-success';
                case 'rejected': return 'bg-danger';
                case 'certified': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        // View registration details
        async function viewDetails(referenceId) {
            try {
                const getUrl = typeof getApiUrl === 'function' ? getApiUrl('/api/get-registration') : '/api/get-registration';
                const response = await fetch(getUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ reference_id: referenceId })
                });

                const data = await response.json();
                
                if (data.success) {
                    const reg = data.registration;
                    alert(`Registration Details:\n\nFarmer: ${reg.farmer_name}\nContact: ${reg.contact_number}\nEmail: ${reg.email_id || 'N/A'}\nLocation: ${reg.village_panchayat}, ${reg.mandal_block}, ${reg.district}, ${reg.state}\nLand: ${reg.total_land} ${reg.land_unit}\nCrop: ${reg.crop_types}\nPractice: ${reg.farming_practice}\nExperience: ${reg.farming_experience} years`);
                } else {
                    alert('Failed to load registration details');
                }
            } catch (error) {
                alert('Error loading details: ' + error.message);
            }
        }

        // Update registration status
        async function updateStatus(referenceId, newStatus) {
            if (!confirm(`Update status to "${newStatus}"?`)) return;

            try {
                const updateUrl = typeof getApiUrl === 'function' ? getApiUrl('/api/update-status') : '/api/update-status';
                const response = await fetch(updateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        reference_id: referenceId, 
                        status: newStatus,
                        inspector: 'Admin Dashboard'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Status updated successfully!');
                    loadRegistrations();
                } else {
                    alert('Failed to update status');
                }
            } catch (error) {
                alert('Error updating status: ' + error.message);
            }
        }

        // Check API status
        async function checkAPIStatus() {
            const container = document.getElementById('api-status');
            
            try {
                const healthUrl = typeof getApiUrl === 'function' ? getApiUrl('/api/health-check') : '/api/health-check';
                const response = await fetch(healthUrl, { credentials: 'include' });
                const data = await response.json();
                
                if (data.status === 'OK') {
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle me-2"></i>
                            <strong>System Online</strong><br>
                            MongoDB: ${data.mongodb || 'Connected'}<br>
                            Last Check: ${new Date(data.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        <strong>System Error</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('registrations-container');
            container.innerHTML = `
                <div class="error">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        // Event listeners
        document.getElementById('status-filter').addEventListener('change', loadRegistrations);

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>